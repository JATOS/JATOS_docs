"use strict";(self.webpackChunkjatos_docs=self.webpackChunkjatos_docs||[]).push([[613],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>d});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),c=p(a),d=r,h=c["".concat(l,".").concat(d)]||c[d]||u[d]||o;return a?n.createElement(h,i(i({ref:t},m),{},{components:a})):n.createElement(h,i({ref:t},m))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},20368:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var n=a(83117),r=(a(67294),a(3905));const o={title:"JATOS in a cluster",slug:"/JATOS-in-a-cluster.html",sidebar_position:10},i=void 0,s={unversionedId:"Serving_the_Internet/JATOS-in-a-cluster",id:"version-3.9.1/Serving_the_Internet/JATOS-in-a-cluster",title:"JATOS in a cluster",description:"JATOS can run on multiple nodes in a cluster to achieve high availability and scalability.",source:"@site/versioned_docs/version-3.9.1/Serving_the_Internet/JATOS-in-a-cluster.md",sourceDirName:"Serving_the_Internet",slug:"/JATOS-in-a-cluster.html",permalink:"/JATOS-in-a-cluster.html",draft:!1,editUrl:"https://github.com/JATOS/JATOS_docs/tree/main/versioned_docs/version-3.9.1/Serving_the_Internet/JATOS-in-a-cluster.md",tags:[],version:"3.9.1",lastUpdatedBy:"Kristian Lange",lastUpdatedAt:1750844467,formattedLastUpdatedAt:"Jun 25, 2025",sidebarPosition:10,frontMatter:{title:"JATOS in a cluster",slug:"/JATOS-in-a-cluster.html",sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"JATOS with Docker Compose",permalink:"/JATOS-with-Docker-Compose.html"},next:{title:"JATOS with Nginx",permalink:"/JATOS-with-Nginx.html"}},l={},p=[{value:"Things to Know Before Running JATOS in a Multi-Node Setup",id:"things-to-know-before-running-jatos-in-a-multi-node-setup",level:2},{value:"Multi-Node Installation with Docker Compose",id:"multi-node-installation-with-docker-compose",level:2},{value:"JATOS with Kubernetes",id:"jatos-with-kubernetes",level:2},{value:"Load Balancing and Scaling",id:"load-balancing-and-scaling",level:3},{value:"Shared Volumes",id:"shared-volumes",level:3},{value:"Configure JATOS&#39; Deployment",id:"configure-jatos-deployment",level:3},{value:"Secrets",id:"secrets",level:3},{value:"MySQL Setup",id:"mysql-setup",level:3},{value:"Liveness Probe and Startup Probe",id:"liveness-probe-and-startup-probe",level:3},{value:"<em>SecurityContext</em> and <em>Affinity</em>",id:"securitycontext-and-affinity",level:3},{value:"Updating JATOS with Kubernetes",id:"updating-jatos-with-kubernetes",level:3}],m={toc:p};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"JATOS can run on multiple nodes in a cluster to achieve high availability and scalability."),(0,r.kt)("h2",{id:"things-to-know-before-running-jatos-in-a-multi-node-setup"},"Things to Know Before Running JATOS in a Multi-Node Setup"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"In a multi-node setup, JATOS requires a ",(0,r.kt)("strong",{parentName:"li"},"MySQL")," or ",(0,r.kt)("strong",{parentName:"li"},"MariaDB")," database (the embedded H2 database cannot be used)."),(0,r.kt)("li",{parentName:"ul"},"All JATOS nodes must ",(0,r.kt)("strong",{parentName:"li"},"share certain folders"),": ",(0,r.kt)("em",{parentName:"li"},"study assets"),", ",(0,r.kt)("em",{parentName:"li"},"study uploads"),", ",(0,r.kt)("em",{parentName:"li"},"study logs"),", and JATOS' ",(0,r.kt)("em",{parentName:"li"},"tmp")," folder."),(0,r.kt)("li",{parentName:"ul"},"All JATOS nodes must use the ",(0,r.kt)("strong",{parentName:"li"},"same secret"),"; otherwise, the session cookie used for authentication will not work."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Updating")," is easiest by changing the tag of the JATOS Docker image to a higher version (the auto-updater cannot be used in a cluster).")),(0,r.kt)("p",null,"All these points (and more) are addressed on this page."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"multi-node-installation-with-docker-compose"},"Multi-Node Installation with Docker Compose"),(0,r.kt)("p",null,"Setting up JATOS with multiple nodes using ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/compose/"},"Docker Compose")," might not make much sense for production, since all instances run on the same machine. However, it demonstrates the general concepts and caveats well."),(0,r.kt)("p",null,"Instructions for getting started with JATOS and Docker Compose are on ",(0,r.kt)("a",{parentName:"p",href:"/JATOS-with-Docker-Compose.html"},"another page"),". You may want to follow those steps to set up JATOS with a MySQL database and Nginx."),(0,r.kt)("p",null,"To run JATOS in multiple containers in parallel, you need to additionally configure the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_docker_compose/blob/main/compose.yaml"},(0,r.kt)("em",{parentName:"a"},"compose.yaml")),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Set ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"strong"},"-Djatos.multiNode=true"))," in the ",(0,r.kt)("em",{parentName:"li"},"command")," section of the ",(0,r.kt)("em",{parentName:"li"},"jatos")," service."),(0,r.kt)("li",{parentName:"ol"},"Set the ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"strong"},"JATOS_SECRET"))," environment variable to a string with at least 15 characters (required for session cookies to work).")),(0,r.kt)("p",null,"It's important to share some JATOS folders between all nodes. In our Docker Compose setup, this is already handled with the shared volumes: ",(0,r.kt)("em",{parentName:"p"},"jatos-data"),", ",(0,r.kt)("em",{parentName:"p"},"jatos-logs"),", and ",(0,r.kt)("em",{parentName:"p"},"jatos-db"),"."),(0,r.kt)("p",null,"To scale up and run multiple JATOS instances, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"--scale")," parameter. For example, to run two JATOS instances:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"docker compose -f compose.yaml up --scale jatos=2\n")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"jatos-with-kubernetes"},"JATOS with Kubernetes"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/"},"Kubernetes")," is a system for container orchestration and automatic deployments. It offers many possibilities, depending on your cloud provider. Here, we use ",(0,r.kt)("a",{parentName:"p",href:"https://docs.digitalocean.com/products/kubernetes/"},"DigitalOcean")," as an example, but with some adjustments, it should work on any Kubernetes cluster."),(0,r.kt)("p",null,"For the JATOS cluster, we use ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/"},"Kustomize")," to define Kubernetes objects via ",(0,r.kt)("em",{parentName:"p"},"kustomization")," YAML files."),(0,r.kt)("p",null,"All necessary files are available in this ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes"},"git repository"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"git clone https://github.com/JATOS/JATOS_with_kubernetes.git\n")),(0,r.kt)("p",null,"The file ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/kustomization.yaml"},(0,r.kt)("em",{parentName:"a"},"kustomization.yaml"))," defines secrets and specifies the resource file ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml")),", which describes the JATOS cluster."),(0,r.kt)("p",null,"After setup, start the cluster with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -k <my_JATOS_kustomize_directory>\n")),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"load-balancing-and-scaling"},"Load Balancing and Scaling"),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml")),", for load balancing, we use the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.digitalocean.com/products/kubernetes/how-to/add-load-balancers/"},"DigitalOcean integrated load balancer"),", specified in the ",(0,r.kt)("em",{parentName:"p"},"Service")," object with the annotation ",(0,r.kt)("inlineCode",{parentName:"p"},'kubernetes.digitalocean.com/load-balancer-id: "jatos-load-balancer"'),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Service\nmetadata:\n  name: jatos\n  labels:\n    app: jatos\n  annotations:\n    kubernetes.digitalocean.com/load-balancer-id: "jatos-load-balancer"\nspec:\n  ports:\n    - port: 80\n      targetPort: 9000\n  selector:\n    app: jatos\n  type: LoadBalancer\n')),(0,r.kt)("p",null,"For automatic horizontal scaling, we use a ",(0,r.kt)("inlineCode",{parentName:"p"},"HorizontalPodAutoscaler"),". Here, we set a minimum of 2 and a maximum of 10 JATOS pods, with an average CPU utilization of 100%."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: jatos\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: jatos\n  minReplicas: 2\n  maxReplicas: 10\n  metrics:\n  - type: Resource\n    resource:\n      name: cpu\n      target:\n        type: Utilization\n        averageUtilization: 100\n")),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"shared-volumes"},"Shared Volumes"),(0,r.kt)("p",null,"As mentioned ",(0,r.kt)("a",{parentName:"p",href:"/JATOS-in-a-cluster.html#things-to-know-before-running-jatos-in-a-multi-node-setup"},"earlier"),", JATOS requires certain folders to be shared when running on multiple nodes. In Kubernetes, this means the ",(0,r.kt)("em",{parentName:"p"},"PersistentVolumeClaim")," must have ",(0,r.kt)("inlineCode",{parentName:"p"},"accessMode"),": ",(0,r.kt)("inlineCode",{parentName:"p"},"ReadWriteMany"),"."),(0,r.kt)("p",null,"While many cloud providers have their own solutions for this, we will use a common ",(0,r.kt)("em",{parentName:"p"},"NFS")," storage in this example. For instance, there is an easy-to-use ",(0,r.kt)("a",{parentName:"p",href:"https://helm.sh/"},"helm chart")," for this purpose: ",(0,r.kt)("a",{parentName:"p",href:"https://artifacthub.io/packages/helm/kvaps/nfs-server-provisioner"},"nfs-server-provisioner"),". If you are using ",(0,r.kt)("em",{parentName:"p"},"DigitalOcean"),", set the parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"persistence.storageClass")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"do-block-storage"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"helm install nfs-server stable/nfs-server-provisioner --set persistence.enabled=true,persistence.storageClass=do-block-storage,persistence.size=11Gi\n")),(0,r.kt)("p",null,"In our ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml")),", the NFS storage is used in a ",(0,r.kt)("inlineCode",{parentName:"p"},"PersistentVolumeClaim"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: jatos-data-pv-claim\n  labels:\n    app: jatos\nspec:\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 10Gi\n  storageClassName: nfs\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("em",{parentName:"p"},"volume")," is then mounted in every JATOS ",(0,r.kt)("em",{parentName:"p"},"pod"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"volumes:\n  - name: jatos-data-storage\n    persistentVolumeClaim:\n      claimName: jatos-data-pv-claim\n")),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"configure-jatos-deployment"},"Configure JATOS' Deployment"),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml")),", to run JATOS on multiple nodes in a cluster, set the parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"-Djatos.multiNode=true"),". The parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"-Djatos.logs.appender=ASYNCSTDOUT")," redirects logging to ",(0,r.kt)("em",{parentName:"p"},"stdout"),", which is generally desired in Kubernetes."),(0,r.kt)("p",null,"The parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"-J-Xmx")," defines the maximum memory allocated to the Java Virtual Machine (JVM) running JATOS. If not set, the JVM may consume excessive memory, affecting the operating system. Here we set it to 1500 MB, but this depends on your underlying hardware."),(0,r.kt)("p",null,"You may also want to change the Docker image version to a different one."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"containers:\n  # Maybe use a newer image version\n  - image: jatos/jatos:3.8.6\n    name: jatos\n    args:\n      # Necessary to run JATOS on multiple nodes\n      - -Djatos.multiNode=true\n      # Logging to stdout\n      - -Djatos.logs.appender=ASYNCSTDOUT\n      # Set the JVM maximum memory usage. It has to fit your machine.\n      - -J-Xmx=1500M\n")),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"secrets"},"Secrets"),(0,r.kt)("p",null,"The password for the MySQL database and the secret for the JATOS session cookie are set in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/kustomization.yaml"},(0,r.kt)("inlineCode",{parentName:"a"},"kustomization.yaml"))," file and then referenced in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml"))," in the JATOS ",(0,r.kt)("em",{parentName:"p"},"deployment")," object."),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"mysql-setup"},"MySQL Setup"),(0,r.kt)("p",null,"We assume that you have your MySQL database set up and ready. Please refer to ",(0,r.kt)("a",{parentName:"p",href:"/JATOS-with-MySQL.html"},"JATOS with MySQL")," for initial setup instructions."),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml")),", change the environmental variable ",(0,r.kt)("inlineCode",{parentName:"p"},"JATOS_DB_URL")," to match your MySQL IP and port."),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"liveness-probe-and-startup-probe"},"Liveness Probe and Startup Probe"),(0,r.kt)("p",null,"Applications running on the JVM may require some initial warm-up time before they are fully functional. Therefore, in addition to the ",(0,r.kt)("inlineCode",{parentName:"p"},"livenessProbe")," in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml")),", we have a ",(0,r.kt)("inlineCode",{parentName:"p"},"startupProbe")," to account for this. You may need to adjust ",(0,r.kt)("inlineCode",{parentName:"p"},"failureThreshold")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"periodSeconds")," based on your system's performance."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"livenessProbe:\n  httpGet:\n    path: /ping\n    port: 9000\n  failureThreshold: 1\n  periodSeconds: 10\nstartupProbe:\n  httpGet:\n    path: /ping\n    port: 9000\n  failureThreshold: 30\n  periodSeconds: 10\n")),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"securitycontext-and-affinity"},(0,r.kt)("em",{parentName:"h3"},"SecurityContext")," and ",(0,r.kt)("em",{parentName:"h3"},"Affinity")),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JATOS/JATOS_with_kubernetes/blob/main/jatos.yaml"},(0,r.kt)("em",{parentName:"a"},"jatos.yaml"))," file also contains a ",(0,r.kt)("em",{parentName:"p"},"securityContext")," and an ",(0,r.kt)("em",{parentName:"p"},"affinity")," section. Generally, you should not need to change anything here. We explain them briefly below."),(0,r.kt)("p",null,"The ",(0,r.kt)("em",{parentName:"p"},"securityContext")," sets the ",(0,r.kt)("em",{parentName:"p"},"UID")," and ",(0,r.kt)("em",{parentName:"p"},"GID")," for the user defined in JATOS' Docker image."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"securityContext:\n  runAsUser: 1000\n  runAsGroup: 1000\n  fsGroup: 1000\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("em",{parentName:"p"},"affinity")," section defines a ",(0,r.kt)("inlineCode",{parentName:"p"},"podAntiAffinity")," rule to ensure that each Kubernetes ",(0,r.kt)("em",{parentName:"p"},"pod")," runs only one instance of JATOS."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"affinity:\n  podAntiAffinity:                                 \n    requiredDuringSchedulingIgnoredDuringExecution:\n    - topologyKey: kubernetes.io/hostname    \n      labelSelector:                               \n        matchLabels:                               \n          app: jatos\n")),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"updating-jatos-with-kubernetes"},"Updating JATOS with Kubernetes"),(0,r.kt)("p",null,"The easiest way to update a JATOS Kubernetes cluster is to ",(0,r.kt)("strong",{parentName:"p"},"just change the JATOS' Docker image tag to a higher version"),". ",(0,r.kt)("a",{parentName:"p",href:"/Update-JATOS.html#automatic-update"},"JATOS' auto-updater")," ",(0,r.kt)("strong",{parentName:"p"},"cannot")," be used here."),(0,r.kt)("p",null,"However, there are some ",(0,r.kt)("strong",{parentName:"p"},"constraints"),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Kubernetes' ",(0,r.kt)("em",{parentName:"li"},"rolling updates")," are not possible with JATOS. You must turn off all JATOS pods, perform the update (change the Docker image tag), and then turn the pods back on."),(0,r.kt)("li",{parentName:"ol"},"JATOS can only be updated to higher version numbers; downgrading will likely break your installation."),(0,r.kt)("li",{parentName:"ol"},"Please ensure you have backups before performing an update.")))}u.isMDXComponent=!0}}]);